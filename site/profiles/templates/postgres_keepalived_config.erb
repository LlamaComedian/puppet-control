<% scope.function_hiera(['pg_drv_cluster_member_hostnames']).each do |host_name,config|
  if host_name == @hostname
    @kd_priority = config['keepalived_priority']
  end
  if host_name == 'vip'
    @vip_ip = config['ip_address']
  end
end %>
vrrp_script postgresql-9.4 {
  script "/usr/pgsql-9.4/bin/repmgr -f /etc/repmgr/9.4/repmgr.conf cluster show 2> /dev/null | grep 'master.*'`hostname`"
  interval 2
  wait 2
}
vrrp_instance PG-CLUSTER {
    state MASTER
    interface eth1
    virtual_router_id 100
    priority <%= @kd_priority %>
    advert_int 1
    virtual_ipaddress {
      <%= @vip_ip %>
    }
    track_script {
      postgresql-9.4
    }
}
