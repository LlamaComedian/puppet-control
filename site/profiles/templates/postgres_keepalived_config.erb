<% scope.function_hiera(['pg_cluster_member_hostnames']).each do |host_name,config|
  trimmed_host_name = @hostname.gsub(/\..*$/, '')
  trimmed_hiera_host_name = host_name.gsub(/\..*$/, '')
  if trimmed_hiera_host_name == trimmed_host_name
    @kd_priority = config['keepalived_priority']
  end
  if config['initial_role'] == 'vip'
    @vip_ip = config['ip_address']
  end
end %>
vrrp_script postgresql-9.4 {
  script "/usr/pgsql-9.4/bin/repmgr -f /etc/repmgr/9.4/repmgr.conf cluster show 2> /dev/null | grep 'master.*'`hostname | sed 's/\..*$//'`"
  interval 2
  wait 2
}
vrrp_instance <%= @application_environment.upcase %>-PG-CLUSTER {
    state MASTER
    interface eth1
    virtual_router_id <%= @vip_ip.split('.').last %>
    priority <%= @kd_priority %>
    advert_int 1
    virtual_ipaddress {
      <%= @vip_ip %>
    }
    track_script {
      postgresql-9.4
    }
}
